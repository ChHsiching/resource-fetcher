name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'        # Official releases: v0.2.0
      - 'v*.*.*-*'      # Pre-releases: v0.2.0-beta.1, v0.3.0-alpha.1
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Create as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  test:
    name: Test CLI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Install dependencies
        working-directory: ./cli
        run: poetry install

      - name: Run tests
        working-directory: ./cli
        run: poetry run pytest ../tests/ -v

  build:
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
        - os: ubuntu-latest
          os_name: linux
          cli_binary: resource-fetcher
          binary_ext: ''
        - os: windows-latest
          os_name: windows
          cli_binary: resource-fetcher.exe
          binary_ext: '.exe'
        - os: macos-latest
          os_name: macos
          cli_binary: resource-fetcher
          binary_ext: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for CHANGELOG generation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Poetry
        shell: bash
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "$APPDATA\Python\Scripts" >> $GITHUB_PATH
          else
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Install dependencies
        shell: bash
        working-directory: ./cli
        run: |
          poetry install
          poetry run pip install pyinstaller

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          # Extract version number from tag (v0.2.0-beta.1 -> 0.2.0-beta.1)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

          # Detect if this is a pre-release version
          if [[ "$VERSION" =~ -(alpha|beta|rc) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release version"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "This is an official release"
          fi

      - name: Generate CHANGELOG
        shell: bash
        run: |
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## [${{ steps.version.outputs.version }}]" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Changes since last release" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits since last tag (or all commits if first release)
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            git log --pretty=format:"- %s" "$PREV_TAG..HEAD" >> CHANGELOG.md
          else
            echo "Generating changelog for initial release"
            git log --pretty=format:"- %s" >> CHANGELOG.md
          fi

      - name: Display CHANGELOG
        shell: bash
        run: cat CHANGELOG.md

      - name: Build CLI binary
        shell: bash
        working-directory: ./cli
        run: |
          poetry run pyinstaller --onefile --name ${{ matrix.cli_binary }} --clean --distpath ../dist-cli src/resource_fetcher_cli/cli/main.py

      - name: Rename binaries with platform suffix (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mv dist-cli/${{ matrix.cli_binary }} dist-cli/resource-fetcher-${{ matrix.os_name }}
          chmod +x dist-cli/resource-fetcher-${{ matrix.os_name }}

      - name: Rename binaries with platform suffix (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mv dist-cli/${{ matrix.cli_binary }} dist-cli/resource-fetcher-${{ matrix.os_name }}.exe

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: resource-fetcher-cli-${{ matrix.os_name }}
          path: |
            dist-cli/resource-fetcher-${{ matrix.os_name }}*
            dist-cli/resource-fetcher-${{ matrix.os_name }}*.exe

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/resource-fetcher-cli-*/*
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
